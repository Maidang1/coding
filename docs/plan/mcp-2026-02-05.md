# MCP å’Œ Skills ç³»ç»Ÿé›†æˆå®Œå–„è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

æœ¬è®¡åˆ’æ—¨åœ¨å®Œå–„å½“å‰é¡¹ç›®ä¸­çš„ MCP (Model Context Protocol) å®ç°ï¼Œå‚è€ƒ OpenAI Codex çš„ MCP å®ç°æ–¹å¼ï¼Œå¢å¼ºè¿æ¥ç®¡ç†ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å’Œé…ç½®ç®¡ç†åŠŸèƒ½ã€‚

**å‚è€ƒèµ„æ–™**ï¼š
- [OpenAI Codex MCP æ–‡æ¡£](https://developers.openai.com/codex/mcp/)
- [Model Context Protocol GitHub](https://github.com/modelcontextprotocol)
- [MCP è¶…æ—¶å’Œé‡è¯•æœ€ä½³å®è·µ](https://octopus.com/blog/mcp-timeout-retry)

## å½“å‰çŠ¶æ€åˆ†æ

### å·²å®Œæˆçš„åŠŸèƒ½

âœ… **MCP åŸºç¡€å®ç°**
- æ”¯æŒ Stdio å’Œ HTTP ä¸¤ç§ä¼ è¾“æ–¹å¼
- McpTool ç±»åŒ…è£… MCP å·¥å…·
- åŸºæœ¬çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆstart, success, errorï¼‰
- ä¸‰å±‚é…ç½®ä¼˜å…ˆçº§ç³»ç»Ÿï¼ˆlocal > project > userï¼‰
- Agent ä¸­å·²é›†æˆ MCP å·¥å…·åŠ è½½

âœ… **Skills ç³»ç»Ÿ**
- å®Œæ•´çš„åˆ†å±‚åè°ƒå™¨æ¶æ„ï¼ˆDiscovery, Parser, Validation, Cacheï¼‰
- æ”¯æŒå¤šä½œç”¨åŸŸï¼ˆRepo, User, System, Adminï¼‰
- äº‹ä»¶é©±åŠ¨ç³»ç»Ÿ
- é…ç½®åŒ–è®¾è®¡
- ä¸ MCP çš„åŸºç¡€é›†æˆï¼ˆSkills å¯å£°æ˜ MCP ä¾èµ–ï¼‰

### éœ€è¦æ”¹è¿›çš„éƒ¨åˆ†

âš ï¸ **MCP è¿æ¥ç®¡ç†**
- è¿æ¥å¤±è´¥åªè®°å½•è­¦å‘Šï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶
- ç¼ºå°‘è¿æ¥æ± å’ŒçŠ¶æ€ç®¡ç†
- æ²¡æœ‰å¥åº·æ£€æŸ¥æœºåˆ¶
- ç¼ºå°‘ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†

âš ï¸ **æ€§èƒ½å’Œç¼“å­˜**
- æ²¡æœ‰ MCP å·¥å…·åˆ—è¡¨çš„ç¼“å­˜ï¼Œæ¯æ¬¡åˆå§‹åŒ–éƒ½è¦é‡æ–°è¿æ¥
- æ²¡æœ‰å·¥å…·è°ƒç”¨è¶…æ—¶é™åˆ¶
- ç¼ºå°‘å¯åŠ¨è¶…æ—¶é…ç½®

âš ï¸ **Skills ä¾èµ–ç®¡ç†**
- Skill ä¾èµ–å¤„ç†æ˜¯ç®€åŒ–ç‰ˆæœ¬
- ç¼ºå°‘é‡å¤æ£€æµ‹å’Œå†²çªè§£å†³æœºåˆ¶
- æ²¡æœ‰ä¾èµ–å›¾æ„å»ºå’Œå¾ªç¯ä¾èµ–æ£€æµ‹

âš ï¸ **é…ç½®ç®¡ç†**
- ç¼ºå°‘å·¥å…·è¿‡æ»¤åŠŸèƒ½ï¼ˆenabledTools/disabledToolsï¼‰
- ç¼ºå°‘æœåŠ¡å™¨å¯ç”¨/ç¦ç”¨å¼€å…³
- ç¼ºå°‘è®¤è¯é…ç½®æ”¯æŒï¼ˆbearer token, OAuthï¼‰
- ç¼ºå°‘è¶…æ—¶é…ç½®ï¼ˆstartup_timeout_sec, tool_timeout_secï¼‰

## å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šMCP è¿æ¥ç®¡ç†å¢å¼ºï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### ç›®æ ‡
å®ç°å¥å£®çš„ MCP è¿æ¥ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬è¿æ¥æ± ã€é‡è¿ç­–ç•¥ã€å¥åº·æ£€æŸ¥å’Œä¼˜é›…å…³é—­ã€‚

#### å…³é”®æ–‡ä»¶

**æ–°å¢æ–‡ä»¶**ï¼š
- `src/core/mcp/connection-manager.ts` - è¿æ¥æ± å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- `src/core/mcp/retry-strategy.ts` - é‡è¿ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- `src/core/mcp/health-checker.ts` - å¥åº·æ£€æŸ¥æœºåˆ¶
- `src/core/mcp/tool-cache.ts` - MCP å·¥å…·ç¼“å­˜
- `src/core/mcp/types.ts` - MCP ç±»å‹å®šä¹‰æ‰©å±•
- `src/core/mcp/transport.ts` - ä¼ è¾“å±‚åˆ›å»ºé€»è¾‘ï¼ˆä» index.ts æå–ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/core/mcp/index.ts` - é‡æ„ä»¥ä½¿ç”¨ ConnectionManager

#### å®æ–½ç»†èŠ‚

**1.1 è¿æ¥ç®¡ç†å™¨ (ConnectionManager)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- ç®¡ç†å¤šä¸ª MCP æœåŠ¡å™¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ
- è¿æ¥çŠ¶æ€æœºï¼šDISCONNECTED â†’ CONNECTING â†’ CONNECTED â†’ RECONNECTING â†’ FAILED
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆä½¿ç”¨ RetryStrategyï¼‰
- äº‹ä»¶å‘å°„ï¼šconnectionStateChanged, connectionError, reconnectAttempt
- æ”¯æŒä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†

å…³é”®æ¥å£ï¼š
```typescript
class ConnectionManager extends EventEmitter {
  async connect(serverName: string, config: McpServerConfig, transport: Transport): Promise<Client>
  async reconnect(serverName: string): Promise<void>
  getConnection(serverName: string): ManagedConnection | undefined
  getAllConnections(): ManagedConnection[]
  async disconnect(serverName: string): Promise<void>
  async disconnectAll(): Promise<void>
}
```

**1.2 é‡è¿ç­–ç•¥ (RetryStrategy)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- æŒ‡æ•°é€€é¿ç®—æ³•ï¼šdelay = min(initialDelay * 2^attempt, maxDelay)
- æ·»åŠ æŠ–åŠ¨ï¼ˆjitterï¼‰é¿å…é›·é¸£ç¾¤æ•ˆåº”
- å¯é…ç½®çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3 æ¬¡ï¼‰
- æ™ºèƒ½é”™è¯¯åˆ†ç±»ï¼ˆç½‘ç»œé”™è¯¯å¯é‡è¯•ï¼Œé…ç½®é”™è¯¯ä¸å¯é‡è¯•ï¼‰

é…ç½®å‚æ•°ï¼š
- `maxRetries`: 3ï¼ˆé»˜è®¤ï¼‰
- `initialDelay`: 1000msï¼ˆé»˜è®¤ï¼‰
- `maxDelay`: 30000msï¼ˆé»˜è®¤ï¼‰
- `jitterFactor`: 0.1ï¼ˆé»˜è®¤ï¼‰

**1.3 å¥åº·æ£€æŸ¥ (HealthChecker)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- å®šæœŸæ£€æŸ¥ MCP æœåŠ¡å™¨å¥åº·çŠ¶æ€ï¼ˆé»˜è®¤ 60 ç§’é—´éš”ï¼‰
- ä½¿ç”¨ `client.listTools()` ä½œä¸ºå¥åº·æ£€æŸ¥æ¢é’ˆ
- è®°å½•å»¶è¿Ÿå’Œé”™è¯¯ä¿¡æ¯
- è§¦å‘ onUnhealthy å›è°ƒç”¨äºè‡ªåŠ¨é‡è¿

**1.4 å·¥å…·ç¼“å­˜ (McpToolCache)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- ç¼“å­˜ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨
- TTL æœºåˆ¶ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
- æ”¯æŒæ‰‹åŠ¨å¤±æ•ˆå’Œè‡ªåŠ¨è¿‡æœŸæ¸…ç†
- å‡å°‘é‡å¤çš„ listTools è°ƒç”¨

**1.5 é…ç½®ç±»å‹æ‰©å±•**

æ–°å¢é…ç½®å­—æ®µï¼ˆå‚è€ƒ OpenAI Codexï¼‰ï¼š
```typescript
interface McpServerConfig {
  // ç°æœ‰å­—æ®µ
  command?: string
  args?: string[]
  env?: Record<string, string>
  cwd?: string
  url?: string
  headers?: Record<string, string>

  // æ–°å¢å­—æ®µ
  enabled?: boolean                    // æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤ trueï¼‰
  startupTimeoutSec?: number          // å¯åŠ¨è¶…æ—¶ï¼ˆé»˜è®¤ 30sï¼‰
  toolTimeoutSec?: number             // å·¥å…·è°ƒç”¨è¶…æ—¶ï¼ˆé»˜è®¤ 60sï¼‰
  enabledTools?: string[]             // å·¥å…·ç™½åå•
  disabledTools?: string[]            // å·¥å…·é»‘åå•
  maxRetries?: number                 // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
  retryDelay?: number                 // åˆå§‹é‡è¯•å»¶è¿Ÿï¼ˆé»˜è®¤ 1000msï¼‰
  healthCheckInterval?: number        // å¥åº·æ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤ 60000msï¼‰

  // è®¤è¯é…ç½®
  auth?: {
    type: "bearer" | "oauth" | "basic"
    token?: string
    username?: string
    password?: string
  }
}
```

#### éªŒè¯æ–¹æ¡ˆ

1. **è¿æ¥ç®¡ç†æµ‹è¯•**
   - å¯åŠ¨åº”ç”¨ï¼ŒéªŒè¯ MCP æœåŠ¡å™¨æ­£å¸¸è¿æ¥
   - æ‰‹åŠ¨åœæ­¢ MCP æœåŠ¡å™¨ï¼ŒéªŒè¯è‡ªåŠ¨é‡è¿
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„é‡è¿å°è¯•å’ŒæŒ‡æ•°é€€é¿å»¶è¿Ÿ

2. **å·¥å…·ç¼“å­˜æµ‹è¯•**
   - é¦–æ¬¡åŠ è½½è®°å½•æ—¶é—´
   - ç¬¬äºŒæ¬¡åŠ è½½åº”ä½¿ç”¨ç¼“å­˜ï¼ˆæ˜¾è‘—æ›´å¿«ï¼‰
   - ç­‰å¾… TTL è¿‡æœŸåéªŒè¯ç¼“å­˜å¤±æ•ˆ

3. **å¥åº·æ£€æŸ¥æµ‹è¯•**
   - è¿è¡Œåº”ç”¨è¶…è¿‡ 60 ç§’
   - æ£€æŸ¥å¥åº·æ£€æŸ¥æ—¥å¿—
   - æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœï¼ŒéªŒè¯å¥åº·æ£€æŸ¥æ£€æµ‹åˆ°é—®é¢˜

4. **é…ç½®æµ‹è¯•**
   - æµ‹è¯• `enabled: false` ç¦ç”¨æœåŠ¡å™¨
   - æµ‹è¯• `enabledTools` ç™½åå•è¿‡æ»¤
   - æµ‹è¯• `disabledTools` é»‘åå•è¿‡æ»¤
   - æµ‹è¯•è¶…æ—¶é…ç½®

---

### é˜¶æ®µ 2ï¼šSkills ä¾èµ–ç®¡ç†å¢å¼ºï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### ç›®æ ‡
å®Œå–„ Skills ç³»ç»Ÿä¸­ MCP å·¥å…·ä¾èµ–çš„è§£æã€å†²çªæ£€æµ‹å’ŒåŠ è½½ç®¡ç†ã€‚

#### å…³é”®æ–‡ä»¶

**æ–°å¢æ–‡ä»¶**ï¼š
- `src/core/skills/dependency/resolver.ts` - ä¾èµ–è§£æå™¨
- `src/core/skills/dependency/conflict-detector.ts` - å†²çªæ£€æµ‹
- `src/core/skills/dependency/graph.ts` - ä¾èµ–å›¾æ„å»º
- `src/core/skills/dependency/types.ts` - ä¾èµ–ç±»å‹å®šä¹‰
- `src/core/skills/integration/mcp-loader.ts` - MCP ä¾èµ–åŠ è½½å™¨
- `src/core/skills/integration/tool-mapper.ts` - å·¥å…·æ˜ å°„
- `src/core/skills/integration/lifecycle.ts` - ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/core/agent/index.ts` - ä½¿ç”¨æ–°çš„ä¾èµ–è§£æå™¨

#### å®æ–½ç»†èŠ‚

**2.1 ä¾èµ–è§£æå™¨ (DependencyResolver)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- è§£æ Skill çš„ MCP å·¥å…·ä¾èµ–
- æ„å»ºä¾èµ–å›¾æ£€æµ‹å¾ªç¯ä¾èµ–
- æ‹“æ‰‘æ’åºç¡®å®šåŠ è½½é¡ºåº
- ç‰ˆæœ¬å†²çªæ£€æµ‹å’Œè§£å†³ç­–ç•¥

å…³é”®æ¥å£ï¼š
```typescript
class DependencyResolver {
  resolve(skills: SkillMetadata[]): ResolvedDependencies
  detectConflicts(dependencies: ToolDependency[]): Conflict[]
  buildDependencyGraph(skills: SkillMetadata[]): DependencyGraph
}
```

**2.2 å†²çªæ£€æµ‹ (ConflictDetector)**

å†²çªç±»å‹ï¼š
- **ç‰ˆæœ¬å†²çª**ï¼šåŒä¸€ MCP æœåŠ¡å™¨çš„ä¸åŒç‰ˆæœ¬
- **é…ç½®å†²çª**ï¼šåŒä¸€æœåŠ¡å™¨çš„ä¸åŒé…ç½®ï¼ˆURLã€å‘½ä»¤ç­‰ï¼‰
- **å·¥å…·åç§°å†²çª**ï¼šä¸åŒæœåŠ¡å™¨æä¾›ç›¸åŒåç§°çš„å·¥å…·

è§£å†³ç­–ç•¥ï¼š
- **ä¼˜å…ˆçº§ç­–ç•¥**ï¼šRepo > User > System > Admin
- **æœ€æ–°ç‰ˆæœ¬ç­–ç•¥**ï¼šé€‰æ‹©æœ€æ–°ç‰ˆæœ¬
- **ç”¨æˆ·é€‰æ‹©ç­–ç•¥**ï¼šæç¤ºç”¨æˆ·é€‰æ‹©ï¼ˆé€šè¿‡ AskUserQuestionï¼‰

**2.3 MCP ä¾èµ–åŠ è½½å™¨ (McpDependencyLoader)**

æ ¸å¿ƒåŠŸèƒ½ï¼š
- ä» Skills ä¾èµ–ä¸­æå– MCP æœåŠ¡å™¨é…ç½®
- åˆå¹¶åˆ°å…¨å±€ MCP é…ç½®ä¸­
- å»é‡å’Œå†²çªè§£å†³
- åŠ¨æ€åŠ è½½ MCP å·¥å…·

å½“å‰å®ç°ä½ç½®ï¼š`src/core/agent/index.ts:127-145`ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰

æ”¹è¿›ç‚¹ï¼š
- æ·»åŠ é‡å¤æ£€æµ‹
- æ·»åŠ å†²çªè§£å†³
- æ”¯æŒä¾èµ–ç‰ˆæœ¬çº¦æŸ
- æ”¯æŒå¯é€‰ä¾èµ–å’Œå¿…éœ€ä¾èµ–

#### éªŒè¯æ–¹æ¡ˆ

1. **ä¾èµ–è§£ææµ‹è¯•**
   - åˆ›å»ºå¤šä¸ª Skillsï¼Œå£°æ˜ç›¸åŒçš„ MCP ä¾èµ–
   - éªŒè¯å»é‡é€»è¾‘
   - éªŒè¯ä¾èµ–å›¾æ„å»º

2. **å†²çªæ£€æµ‹æµ‹è¯•**
   - åˆ›å»ºä¸¤ä¸ª Skillsï¼Œå£°æ˜åŒä¸€ MCP æœåŠ¡å™¨çš„ä¸åŒé…ç½®
   - éªŒè¯å†²çªæ£€æµ‹å’Œè§£å†³ç­–ç•¥
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„å†²çªè­¦å‘Š

3. **å¾ªç¯ä¾èµ–æµ‹è¯•**
   - åˆ›å»ºå¾ªç¯ä¾èµ–çš„ Skillsï¼ˆå¦‚æœæ”¯æŒ Skill é—´ä¾èµ–ï¼‰
   - éªŒè¯å¾ªç¯æ£€æµ‹å’Œé”™è¯¯æŠ¥å‘Š

---

### é˜¶æ®µ 3ï¼šé…ç½®ç®¡ç†å’Œå·¥å…·è¿‡æ»¤ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### ç›®æ ‡
å¢å¼ºé…ç½®ç³»ç»Ÿï¼Œæ”¯æŒå·¥å…·è¿‡æ»¤ã€è®¤è¯é…ç½®å’Œè¶…æ—¶è®¾ç½®ã€‚

#### å…³é”®æ–‡ä»¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/core/config/index.ts` - æ‰©å±•é…ç½® schema
- `src/core/mcp/index.ts` - å®ç°å·¥å…·è¿‡æ»¤é€»è¾‘

#### å®æ–½ç»†èŠ‚

**3.1 å·¥å…·è¿‡æ»¤**

å®ç°é€»è¾‘ï¼š
```typescript
function filterTools(
  tools: McpToolDefinition[],
  config: McpServerConfig
): McpToolDefinition[] {
  let filtered = tools;

  // ç™½åå•è¿‡æ»¤
  if (config.enabledTools && config.enabledTools.length > 0) {
    filtered = filtered.filter(tool =>
      config.enabledTools!.includes(tool.name)
    );
  }

  // é»‘åå•è¿‡æ»¤
  if (config.disabledTools && config.disabledTools.length > 0) {
    filtered = filtered.filter(tool =>
      !config.disabledTools!.includes(tool.name)
    );
  }

  return filtered;
}
```

**3.2 è¶…æ—¶é…ç½®**

å®ç°ä½ç½®ï¼š
- `startupTimeoutSec`ï¼šåœ¨ `client.connect()` æ—¶ä½¿ç”¨ Promise.race å®ç°è¶…æ—¶
- `toolTimeoutSec`ï¼šåœ¨ `McpTool.execute()` æ—¶ä½¿ç”¨ Promise.race å®ç°è¶…æ—¶

ç¤ºä¾‹ï¼š
```typescript
async function connectWithTimeout(
  client: Client,
  transport: Transport,
  timeoutSec: number = 30
): Promise<void> {
  const timeoutPromise = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Connection timeout')), timeoutSec * 1000)
  );

  await Promise.race([
    client.connect(transport),
    timeoutPromise
  ]);
}
```

**3.3 è®¤è¯é…ç½®**

æ”¯æŒçš„è®¤è¯ç±»å‹ï¼š
- **Bearer Token**ï¼šåœ¨ HTTP headers ä¸­æ·»åŠ  `Authorization: Bearer <token>`
- **Basic Auth**ï¼šåœ¨ HTTP headers ä¸­æ·»åŠ  `Authorization: Basic <base64>`
- **OAuth**ï¼šå®ç° OAuth 2.0 å®¢æˆ·ç«¯å‡­è¯æµç¨‹

å®ç°ä½ç½®ï¼š`src/core/mcp/transport.ts`

#### éªŒè¯æ–¹æ¡ˆ

1. **å·¥å…·è¿‡æ»¤æµ‹è¯•**
   - é…ç½® `enabledTools: ["tool1", "tool2"]`
   - éªŒè¯åªæœ‰è¿™ä¸¤ä¸ªå·¥å…·è¢«åŠ è½½
   - é…ç½® `disabledTools: ["tool3"]`
   - éªŒè¯ tool3 è¢«æ’é™¤

2. **è¶…æ—¶æµ‹è¯•**
   - é…ç½® `startupTimeoutSec: 5`
   - ä½¿ç”¨ä¸€ä¸ªæ…¢å¯åŠ¨çš„ MCP æœåŠ¡å™¨
   - éªŒè¯ 5 ç§’åè¶…æ—¶å¹¶æŠ¥é”™

3. **è®¤è¯æµ‹è¯•**
   - é…ç½® bearer token è®¤è¯
   - éªŒè¯ HTTP è¯·æ±‚åŒ…å«æ­£ç¡®çš„ Authorization header
   - æµ‹è¯•è®¤è¯å¤±è´¥çš„é”™è¯¯å¤„ç†

---

### é˜¶æ®µ 4ï¼šUI å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### ç›®æ ‡
æä¾›æ›´å¥½çš„ç”¨æˆ·åé¦ˆå’Œé…ç½®ç®¡ç†ç•Œé¢ã€‚

#### å…³é”®æ–‡ä»¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/render/index.tsx` - å¢å¼º MCP çŠ¶æ€æ˜¾ç¤º

#### å®æ–½ç»†èŠ‚

**4.1 å¢å¼º MCP çŠ¶æ€æ˜¾ç¤º**

å½“å‰å®ç°ï¼š
- âœ… è¿æ¥å¼€å§‹ï¼š`ğŸ”Œ MCP è¿æ¥ä¸­: ${serverName}`
- âœ… è¿æ¥æˆåŠŸï¼š`âœ… MCP å·²è¿æ¥: ${serverName} (tools: ${toolCount})`
- âŒ è¿æ¥å¤±è´¥ï¼š`âŒ MCP è¿æ¥å¤±è´¥: ${serverName}\n${error.message}`

æ”¹è¿›ç‚¹ï¼š
- æ˜¾ç¤ºé‡è¿å°è¯•ï¼š`ğŸ”„ MCP é‡è¿ä¸­: ${serverName} (å°è¯• ${attempt}/${maxRetries})`
- æ˜¾ç¤ºå¥åº·æ£€æŸ¥çŠ¶æ€ï¼š`ğŸ’š MCP å¥åº·: ${serverName} (å»¶è¿Ÿ: ${latency}ms)`
- æ˜¾ç¤ºå·¥å…·è¿‡æ»¤ä¿¡æ¯ï¼š`ğŸ”§ MCP å·¥å…·å·²è¿‡æ»¤: ${serverName} (${filteredCount}/${totalCount})`
- æ˜¾ç¤ºç¼“å­˜å‘½ä¸­ï¼š`âš¡ MCP ç¼“å­˜å‘½ä¸­: ${serverName}`

**4.2 é…ç½®éªŒè¯å’Œé”™è¯¯æç¤º**

åœ¨åŠ è½½é…ç½®æ—¶éªŒè¯ï¼š
- æ£€æŸ¥å¿…éœ€å­—æ®µï¼ˆcommand æˆ– urlï¼‰
- æ£€æŸ¥å†²çªé…ç½®ï¼ˆenabledTools å’Œ disabledTools åŒæ—¶åŒ…å«ç›¸åŒå·¥å…·ï¼‰
- æ£€æŸ¥è¶…æ—¶å€¼çš„åˆç†æ€§ï¼ˆä¸èƒ½ä¸ºè´Ÿæ•°æˆ–è¿‡å¤§ï¼‰
- æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

#### éªŒè¯æ–¹æ¡ˆ

1. **UI æµ‹è¯•**
   - å¯åŠ¨åº”ç”¨ï¼Œè§‚å¯Ÿ MCP è¿æ¥çŠ¶æ€æ¶ˆæ¯
   - æ¨¡æ‹Ÿè¿æ¥å¤±è´¥ï¼Œè§‚å¯Ÿé‡è¿æ¶ˆæ¯
   - è§‚å¯Ÿå¥åº·æ£€æŸ¥çŠ¶æ€æ›´æ–°

2. **é…ç½®éªŒè¯æµ‹è¯•**
   - æä¾›æ— æ•ˆé…ç½®ï¼ˆç¼ºå°‘ command å’Œ urlï¼‰
   - éªŒè¯é”™è¯¯æ¶ˆæ¯æ¸…æ™°æ˜“æ‡‚
   - æä¾›å†²çªé…ç½®ï¼ŒéªŒè¯è­¦å‘Šæ¶ˆæ¯

---

## å…³é”®æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ï¼ˆå…± 13 ä¸ªï¼‰

**MCP è¿æ¥ç®¡ç†ï¼ˆ6 ä¸ªï¼‰**ï¼š
```
src/core/mcp/connection-manager.ts
src/core/mcp/retry-strategy.ts
src/core/mcp/health-checker.ts
src/core/mcp/tool-cache.ts
src/core/mcp/types.ts
src/core/mcp/transport.ts
```

**Skills ä¾èµ–ç®¡ç†ï¼ˆ7 ä¸ªï¼‰**ï¼š
```
src/core/skills/dependency/resolver.ts
src/core/skills/dependency/conflict-detector.ts
src/core/skills/dependency/graph.ts
src/core/skills/dependency/types.ts
src/core/skills/integration/mcp-loader.ts
src/core/skills/integration/tool-mapper.ts
src/core/skills/integration/lifecycle.ts
```

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå…± 4 ä¸ªï¼‰

```
src/core/mcp/index.ts              # é‡æ„ä»¥ä½¿ç”¨ ConnectionManager
src/core/config/index.ts           # æ‰©å±•é…ç½® schema
src/core/agent/index.ts            # ä½¿ç”¨æ–°çš„ä¾èµ–è§£æå™¨
src/render/index.tsx               # å¢å¼º MCP çŠ¶æ€æ˜¾ç¤º
```

---

## æŠ€æœ¯ç»†èŠ‚

### é‡è¿ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ç®—æ³•

```
å°è¯•æ¬¡æ•° | å»¶è¿Ÿè®¡ç®— | å®é™…å»¶è¿Ÿï¼ˆå«æŠ–åŠ¨ï¼‰
--------|---------|------------------
0       | 1s      | 1.0s - 1.1s
1       | 2s      | 2.0s - 2.2s
2       | 4s      | 4.0s - 4.4s
3       | 8s      | 8.0s - 8.8s
4       | 16s     | 16.0s - 17.6s
5       | 30s (max) | 30.0s - 33.0s
```

å…¬å¼ï¼š`delay = min(initialDelay * 2^attempt, maxDelay) + jitter`

### ç¼“å­˜ç­–ç•¥

**MCP å·¥å…·åˆ—è¡¨ç¼“å­˜**ï¼š
- TTLï¼š5 åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- å¤±æ•ˆæ¡ä»¶ï¼š
  - è¶…è¿‡ TTL
  - æ‰‹åŠ¨è°ƒç”¨ `invalidate()`
  - è¿æ¥æ–­å¼€åé‡è¿
- ç¼“å­˜é”®ï¼šæœåŠ¡å™¨åç§°

**Skills åŠ è½½ç»“æœç¼“å­˜**ï¼š
- å·²åœ¨ `src/core/skills/cache/` ä¸­å®ç°
- TTLï¼š5 åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- å¤±æ•ˆæ¡ä»¶ï¼š
  - è¶…è¿‡ TTL
  - æ‰‹åŠ¨è°ƒç”¨ `forceReload`

### é”™è¯¯åˆ†ç±»

**å¯é‡è¯•é”™è¯¯**ï¼š
- `ECONNREFUSED` - è¿æ¥è¢«æ‹’ç»
- `ETIMEDOUT` - è¿æ¥è¶…æ—¶
- `ENOTFOUND` - ä¸»æœºæœªæ‰¾åˆ°
- `socket hang up` - Socket æŒ‚èµ·

**ä¸å¯é‡è¯•é”™è¯¯**ï¼š
- é…ç½®é”™è¯¯ï¼ˆç¼ºå°‘å¿…éœ€å­—æ®µï¼‰
- è®¤è¯é”™è¯¯ï¼ˆ401, 403ï¼‰
- åè®®é”™è¯¯ï¼ˆMCP åè®®ä¸å…¼å®¹ï¼‰

### å·¥å…·è¶…æ—¶å®ç°

```typescript
async execute(input: any): Promise<string> {
  const timeoutMs = this.config.toolTimeoutSec
    ? this.config.toolTimeoutSec * 1000
    : 60000;

  const timeoutPromise = new Promise<never>((_, reject) =>
    setTimeout(() => reject(new Error('Tool execution timeout')), timeoutMs)
  );

  const result = await Promise.race([
    this.client.callTool({ name: this.toolName, arguments: input }),
    timeoutPromise
  ]);

  return formatToolResult(result);
}
```

---

## ç«¯åˆ°ç«¯éªŒè¯æ–¹æ¡ˆ

### æµ‹è¯•åœºæ™¯ 1ï¼šæ­£å¸¸å¯åŠ¨å’Œå·¥å…·è°ƒç”¨

1. å¯åŠ¨åº”ç”¨ï¼š`bun run src/index.ts`
2. éªŒè¯ MCP æœåŠ¡å™¨è¿æ¥æˆåŠŸ
3. åˆ—å‡ºå¯ç”¨å·¥å…·ï¼ˆåº”åŒ…å« MCP å·¥å…·ï¼‰
4. è°ƒç”¨ä¸€ä¸ª MCP å·¥å…·
5. éªŒè¯å·¥å…·æ‰§è¡ŒæˆåŠŸ

### æµ‹è¯•åœºæ™¯ 2ï¼šè¿æ¥å¤±è´¥å’Œè‡ªåŠ¨é‡è¿

1. é…ç½®ä¸€ä¸ªæ— æ•ˆçš„ MCP æœåŠ¡å™¨ï¼ˆé”™è¯¯çš„ URL æˆ–å‘½ä»¤ï¼‰
2. å¯åŠ¨åº”ç”¨
3. è§‚å¯Ÿè¿æ¥å¤±è´¥å’Œé‡è¿å°è¯•
4. éªŒè¯æŒ‡æ•°é€€é¿å»¶è¿Ÿ
5. éªŒè¯è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ååœæ­¢

### æµ‹è¯•åœºæ™¯ 3ï¼šå·¥å…·ç¼“å­˜

1. é¦–æ¬¡å¯åŠ¨åº”ç”¨ï¼Œè®°å½• MCP å·¥å…·åŠ è½½æ—¶é—´
2. ä¸å…³é—­åº”ç”¨ï¼Œç­‰å¾… 1 åˆ†é’Ÿ
3. è§¦å‘å·¥å…·åˆ—è¡¨åˆ·æ–°ï¼ˆå¦‚æœæœ‰æ­¤åŠŸèƒ½ï¼‰
4. éªŒè¯ä½¿ç”¨ç¼“å­˜ï¼ˆåŠ è½½æ—¶é—´æ˜¾è‘—å‡å°‘ï¼‰
5. ç­‰å¾… 5 åˆ†é’Ÿï¼ˆTTL è¿‡æœŸï¼‰
6. å†æ¬¡åˆ·æ–°ï¼ŒéªŒè¯ç¼“å­˜å¤±æ•ˆå¹¶é‡æ–°åŠ è½½

### æµ‹è¯•åœºæ™¯ 4ï¼šSkills ä¾èµ–åŠ è½½

1. åˆ›å»ºä¸€ä¸ª Skillï¼Œå£°æ˜ MCP å·¥å…·ä¾èµ–
2. å¯åŠ¨åº”ç”¨
3. éªŒè¯ MCP æœåŠ¡å™¨è¢«è‡ªåŠ¨åŠ è½½
4. éªŒè¯ Skill å¯ä»¥ä½¿ç”¨ä¾èµ–çš„å·¥å…·
5. åˆ›å»ºç¬¬äºŒä¸ª Skillï¼Œå£°æ˜ç›¸åŒçš„ MCP ä¾èµ–
6. éªŒè¯å»é‡é€»è¾‘ï¼ˆä¸ä¼šé‡å¤åŠ è½½ï¼‰

### æµ‹è¯•åœºæ™¯ 5ï¼šå·¥å…·è¿‡æ»¤

1. é…ç½® MCP æœåŠ¡å™¨ï¼Œè®¾ç½® `enabledTools: ["tool1"]`
2. å¯åŠ¨åº”ç”¨
3. éªŒè¯åªæœ‰ tool1 è¢«åŠ è½½
4. ä¿®æ”¹é…ç½®ä¸º `disabledTools: ["tool2"]`
5. é‡å¯åº”ç”¨
6. éªŒè¯ tool2 è¢«æ’é™¤

### æµ‹è¯•åœºæ™¯ 6ï¼šå¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤

1. å¯åŠ¨åº”ç”¨ï¼ŒMCP æœåŠ¡å™¨æ­£å¸¸è¿æ¥
2. è¿è¡Œåº”ç”¨è¶…è¿‡ 60 ç§’
3. è§‚å¯Ÿå¥åº·æ£€æŸ¥æ—¥å¿—
4. æ‰‹åŠ¨åœæ­¢ MCP æœåŠ¡å™¨è¿›ç¨‹
5. ç­‰å¾…å¥åº·æ£€æŸ¥æ£€æµ‹åˆ°æ•…éšœ
6. è§‚å¯Ÿè‡ªåŠ¨é‡è¿å°è¯•
7. é‡æ–°å¯åŠ¨ MCP æœåŠ¡å™¨
8. éªŒè¯è¿æ¥æ¢å¤

---

## å‘åå…¼å®¹æ€§

### ä¿æŒç°æœ‰æ¥å£ä¸å˜

**SkillsManager**ï¼š
```typescript
class SkillsManager {
  constructor(codexHome: string)  // ä¿æŒä¸å˜
  getSkillsForCwd(cwd: string, forceReload?: boolean): SkillLoadOutcome  // ä¿æŒä¸å˜
  clearCache(): void  // ä¿æŒä¸å˜
}
```

**loadMcpTools**ï¼š
```typescript
export async function loadMcpTools(
  mcpServersOverride?: Record<string, McpServerConfig>,
  hooks?: {
    onServerConnectStart?: (serverName: string) => void;
    onServerConnectSuccess?: (serverName: string, toolCount: number) => void;
    onServerConnectError?: (serverName: string, error: Error) => void;
  }
): Promise<{
  tools: Tool[];
  cleanup: () => Promise<void>;
  // æ–°å¢ï¼šè¿”å› ConnectionManager ä¾›é«˜çº§ç”¨æˆ·ä½¿ç”¨
  connectionManager?: ConnectionManager;
}>
```

### é…ç½®å‘åå…¼å®¹

æ‰€æœ‰æ–°å¢çš„é…ç½®å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤å€¼ä¿æŒç°æœ‰è¡Œä¸ºï¼š
- `enabled`: é»˜è®¤ `true`
- `startupTimeoutSec`: é»˜è®¤ `30`
- `toolTimeoutSec`: é»˜è®¤ `60`
- `maxRetries`: é»˜è®¤ `3`
- `healthCheckInterval`: é»˜è®¤ `60000`

ç°æœ‰é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œã€‚

---

## ä¾èµ–æ£€æŸ¥

### éœ€è¦çš„ npm åŒ…

å½“å‰å·²å®‰è£…ï¼š
- `@modelcontextprotocol/sdk`: ^1.17.5 âœ…
- `@anthropic-ai/sdk`: ^0.72.1 âœ…
- `zod`: éœ€è¦æ£€æŸ¥æ˜¯å¦å·²å®‰è£…

æ£€æŸ¥å‘½ä»¤ï¼š
```bash
bun pm ls zod
```

å¦‚æœæœªå®‰è£…ï¼Œéœ€è¦æ·»åŠ ï¼š
```bash
bun add zod
```

---

## å®æ–½ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰
1. **é˜¶æ®µ 1ï¼šMCP è¿æ¥ç®¡ç†å¢å¼º**
   - æœ€å¤§çš„æ”¹è¿›ç‚¹
   - è§£å†³å½“å‰æœ€ä¸¥é‡çš„é—®é¢˜ï¼ˆæ— é‡è¿ã€æ— ç¼“å­˜ï¼‰
   - ä¸ºåç»­é˜¶æ®µå¥ å®šåŸºç¡€

### ä¸­ä¼˜å…ˆçº§ï¼ˆåç»­å®æ–½ï¼‰
2. **é˜¶æ®µ 2ï¼šSkills ä¾èµ–ç®¡ç†å¢å¼º**
   - æ”¹è¿›ç”¨æˆ·ä½“éªŒ
   - é¿å…ä¾èµ–å†²çªé—®é¢˜

3. **é˜¶æ®µ 3ï¼šé…ç½®ç®¡ç†å’Œå·¥å…·è¿‡æ»¤**
   - å¢åŠ çµæ´»æ€§
   - å‚è€ƒ OpenAI Codex çš„åŠŸèƒ½

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
4. **é˜¶æ®µ 4ï¼šUI å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›**
   - é”¦ä¸Šæ·»èŠ±
   - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

---

## é¢„æœŸæˆæœ

å®Œæˆæœ¬è®¡åˆ’åï¼Œé¡¹ç›®å°†å…·å¤‡ï¼š

âœ… **å¥å£®çš„è¿æ¥ç®¡ç†**
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œæé«˜å¯é æ€§
- å¥åº·æ£€æŸ¥ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- ä¼˜é›…å…³é—­ï¼Œé¿å…èµ„æºæ³„æ¼

âœ… **ä¼˜ç§€çš„æ€§èƒ½**
- å·¥å…·åˆ—è¡¨ç¼“å­˜ï¼Œå‡å°‘é‡å¤åŠ è½½
- å¯é…ç½®çš„è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
- é«˜æ•ˆçš„ä¾èµ–è§£æ

âœ… **çµæ´»çš„é…ç½®**
- å·¥å…·è¿‡æ»¤ï¼ŒæŒ‰éœ€åŠ è½½
- è®¤è¯æ”¯æŒï¼Œè¿æ¥ç§æœ‰æœåŠ¡
- ç»†ç²’åº¦æ§åˆ¶ï¼Œæ»¡è¶³å„ç§åœºæ™¯

âœ… **å®Œå–„çš„ Skills é›†æˆ**
- è‡ªåŠ¨åŠ è½½ MCP ä¾èµ–
- å†²çªæ£€æµ‹å’Œè§£å†³
- ä¾èµ–å›¾å¯è§†åŒ–

âœ… **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**
- æ¸…æ™°çš„çŠ¶æ€åé¦ˆ
- è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
- å®Œæ•´çš„æ–‡æ¡£

---

## å‚è€ƒèµ„æ–™

- [OpenAI Codex MCP æ–‡æ¡£](https://developers.openai.com/codex/mcp/)
- [Model Context Protocol GitHub](https://github.com/modelcontextprotocol)
- [MCP SDK æ–‡æ¡£](https://github.com/modelcontextprotocol/sdk)
- [æŒ‡æ•°é€€é¿æœ€ä½³å®è·µ](https://betterstack.com/community/guides/monitoring/exponential-backoff/)
- [AWS é‡è¯•æ¨¡å¼](https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/retry-backoff.html)
- [MCP è¶…æ—¶å’Œé‡è¯•](https://octopus.com/blog/mcp-timeout-retry)
